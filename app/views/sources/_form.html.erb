<%#<%= simple_form_for (@content_provider ? [@content_provider, @source] : @source), html: { class: 'source', multipart: true } do |f| %>
<%= simple_form_for (@source), html: { class: 'source', multipart: true } do |f| %>
  <%= render partial: 'common/error_summary', locals: { resource: @source } %>

  <% unless @content_provider %>
    <%= f.input :content_provider_id,
                collection: current_user.get_editable_providers,
                label_method: :title,
                value_method: :id,
                include_blank: false %>
  <% end %>

  <%= render partial: 'common/url_checker',
             locals: { f: f, url: sources_check_exists_path, title: t('sources.hints.url') } %>


  <%= f.input :method, label: 'Ingestion Method',
              hint: t('sources.hints.method'),
              as: :grouped_select,
              group_method: :last,
              collection: grouped_ingestor_options_for_select,
              include_blank: false %>

  <%= f.input :token, hint: t('sources.hints.token'), label: 'Authentication Token' %>

  <%= f.input :default_language,
              collection: LanguageDictionary.instance.options_for_select,
              prompt: t('sources.prompts.default_language'), include_blank: true,
              hint: t('sources.hints.default_language') %>

  <%= f.input :enabled, hint: t('sources.hints.enabled') %>

  <% if policy(@source).approve? %>
    <%= f.input :approval_status,
                label: 'Approval Status',
                collection: approval_options_for_select,
                include_blank: false %>
  <% end %>

  <%= f.input :keyword_filter, hint: 'Comma separated list of keywords that must be present. Leave empty to disable filter.', label: 'Keyword Filter' %>

  <h3>Filters</h3>

  <% f.object.source_filters.load %>
  <%= 'hi' %>
  <%= f.object.class %>
  <%= f.object.persisted? %>
  <%= f.object.nested_attributes_options %>
  <%= f.object.association(:source_filters).reader.class %>
  <%= f.object.source_filters.loaded? %><br>
  <%= f.object.source_filters.any? %><br>
  <%= f.object.source_filters.map(&:marked_for_destruction?) %><br>
  <%= @source.object_id %><br>
  <%= f.object.object_id %><br>
  <div class="form-group" id="source-filters">

    
    <% f.object.source_filters.each_with_index do |sf, index| %>
      <%= fields_for "source[source_filters_attributes][#{index}]", sf do |ff| %>
        <span>a source exists</span>
        <%= ff.text_field :filter_value %>
      <% end %>
    <% end %>
    
    <div id="source-filter-list">
      <% f.simple_fields_for :source_filters do |ff| %>
        <span>a source exists</span>
        <%= render partial: 'source_filter_form', locals: { f: ff } %>
      <% end %>
    </div>

    <div id="source-filter-list">
      <% f.fields_for :source_filters, @source.source_filters do |ff| %>
        <span>a source exists</span>
        <%= render partial: 'source_filter_form', locals: { f: ff } %>
      <% end %>
    </div>

    <% f.object.source_filters.each do |filter| %>
      <div>
        <%= f.simple_fields_for :source_filters, filter, child_index: filter.id do |ff| %>
          <%= render partial: 'source_filter_form', locals: { f: ff } %>
        <% end %>
      </div>
    <% end %>

    <a href="#" id="add-source-filter-btn" class="btn btn-icon">
      <i class="icon icon-h4 plus-icon"></i>
    </a>
    <span id="add-source-filter-btn-label" class="help-inline-block help-block">Add filter condition</span>
  </div>

  <div class="form-group actions">
    <%= f.submit(class: 'btn btn-primary') %>
    <%= link_to t('.cancel', default: t("helpers.links.cancel")),
                sources_path, class: 'btn btn-default' %>
  </div>

  <div id="source-filter-template" style="display: none">
    <%= f.simple_fields_for :source_filters, SourceFilter.new, child_index: "REPLACE_ME" do |ff| %>
      <%= render partial: 'source_filter_form', locals: { f: ff } %>
    <% end %>
  </div>

<% end %>
